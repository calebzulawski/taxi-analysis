<!doctype html>
<html>
<head>
    <title>Taxi Analysis</title>
    <link href='http://fonts.googleapis.com/css?family=Palanquin:300,400,600' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="css/neighborhoods.css">
    <script src="./node_modules/jquery/dist/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.17/require.min.js"></script>
    <script type="text/javascript" src="http://mbostock.github.io/d3/talk/20111116/d3/d3.js"></script>
    <script type="text/javascript" src="http://mbostock.github.io/d3/talk/20111116/d3/d3.csv.js"></script>
    <script type="text/javascript" src="http://mbostock.github.io/d3/talk/20111116/d3/d3.geo.js"></script>
    <script type="text/javascript" src="http://mbostock.github.io/d3/talk/20111116/d3/d3.geom.js"></script>

</head>
<body>

<script>
    // require(['/taxi-analysis/cabbie_stats/js/main.js'], function(){
        // require(['neighborhoods']);
    // });
    var baseUrl = '/taxi-analysis/cabbie_stats/data/'

    var w = 1280,
        h = 800;

    var projection = d3.geo.azimuthal()
        .mode("equidistant")
        .origin([-74, 40])
        .scale(70000)
        .translate([640, 1200]);

    var path = d3.geo.path()
        .projection(projection);

    var svg = d3.select("body").insert("svg:svg", "h2")
        .attr("width", w)
        .attr("height", h);

    var states = svg.append("svg:g")
        .attr("id", "states");

    var circles = svg.append("svg:g")
        .attr("id", "circles");

    var cells = svg.append("svg:g")
        .attr("id", "cells");

    d3.select("input[type=checkbox]").on("change", function() {
      cells.classed("voronoi", this.checked);
    });

    d3.json(baseUrl + "../../webapp/json/community_districts.geojson", function(collection) {
      states.selectAll("path")
          .data(collection.features)
        .enter().append("svg:path")
          .attr("d", path);
    });

    d3.csv(baseUrl + "trip_count.csv", function(flights) {
      var linksByOrigin = {},
          countByNeighborhood = {},
          locationByNeighborhood = {},
          positions = [];

      var arc = d3.geo.greatArc()
          .source(function(d) { return locationByNeighborhood[d.source]; })
          .target(function(d) { return locationByNeighborhood[d.target]; });

      flights.forEach(function(flight) {
        var origin = flight.origin,
            destination = flight.destination,
            links = linksByOrigin[origin] || (linksByOrigin[origin] = []);
        links.push({source: origin, target: destination});
        countByNeighborhood[origin] = (countByNeighborhood[origin] || 0) + 1;
        countByNeighborhood[destination] = (countByNeighborhood[destination] || 0) + 1;
      });

      d3.csv(baseUrl + "neighborhoods.csv", function(neighborhoods) {

        // Only consider airports with at least one flight.
        neighborhoods = neighborhoods.filter(function(neighborhood) {
          if (countByNeighborhood[neighborhood.id]) {
            var location = [neighborhood.longitude, +neighborhood.latitude];
            locationByNeighborhood[neighborhood.id] = location;
            positions.push(projection(location));
            return true;
          }
        });

        // Compute the Voronoi diagram of airports' projected positions.
        var polygons = d3.geom.voronoi(positions);

        var g = cells.selectAll("g")
            .data(neighborhoods)
          .enter().append("svg:g");

        g.append("svg:path")
            .attr("class", "cell")
            .attr("d", function(d, i) { return "M" + polygons[i].join("L") + "Z"; })
            .on("mouseover", function(d, i) { d3.select("h2 span").text(d.name); });

        g.selectAll("path.arc")
            .data(function(d) { return linksByOrigin[d.id] || []; })
          .enter().append("svg:path")
            .attr("class", "arc")
            .attr("d", function(d) { return path(arc(d)); });

        circles.selectAll("circle")
            .data(neighborhoods)
          .enter().append("svg:circle")
            .attr("cx", function(d, i) { return positions[i][0]; })
            .attr("cy", function(d, i) { return positions[i][1]; })
            .attr("r", function(d, i) { return Math.sqrt(countByNeighborhood[d.id]); })
            .sort(function(a, b) { return countByNeighborhood[b.id] - countByNeighborhood[a.id]; });
      });
    });
</script>
</body>
</html>